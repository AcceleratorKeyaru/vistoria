
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vistoria ‚Äî Assistir</title>
  <link rel="stylesheet" href="assets.css" />
  <script src="https://meet.jit.si/external_api.js"></script>
</head>
<body>
  <div class="overlay">
    <div class="card">
      <div class="header">
        <div class="h-title">
          <h1>Vistoria ‚Äî Assistir (Atendente)</h1>
          <div class="sub">Sala: <span id="roomLabel">‚Äî</span></div>
        </div>
        <div class="badge"><span class="dot warn"></span><span>Conectando‚Ä¶</span></div>
      </div>
      <div class="grid">
        <div class="row">
          <button class="btn" id="reload">Recarregar</button>
          <button class="btn" id="refocus">Re-focar v√≠deo</button>
          <button class="btn danger" id="openDashboard">Dashboard</button>
        </div>
        <div class="small">
          Abra <b>este link primeiro</b>. Depois envie o link do associado.<br/>
          Dica: mic/c√¢mera/tela cheia/compartilhar tela ficam nos bot√µes do pr√≥prio Jitsi (embaixo).
        </div>
        <div style="position:fixed;bottom:20px;right:20px;z-index:9999">
    <button onclick="iniciarGravacao()">üé• Gravar Vistoria</button>
    <button onclick="pararGravacao()">‚èπÔ∏è Parar</button>
</div>
      </div>
    </div>
  </div>

  <div id="jitsi"></div>

  <footer class="credits">
    Plataforma desenvolvida por <b>Pedro Vin√≠cius Moraes Alves</b>
  </footer>
  
  <script>
    
function getRoom(){
  const qs = new URLSearchParams(location.search);
  return (qs.get('r') || '').trim();
}
function setBadge(state, text){
  const dot = document.querySelector('.badge .dot');
  const label = document.querySelector('.badge span:last-child');
  if(!dot || !label) return;
  dot.classList.remove('good','warn','bad');
  dot.classList.add(state);
  label.textContent = text;
}

    const room = getRoom();
    document.getElementById('roomLabel').textContent = room || '‚Äî';
    document.getElementById('reload').onclick = ()=>location.reload();
    document.getElementById('openDashboard').onclick = ()=>location.href='admin.html';
    if(!room){
      setBadge('bad','Sem sala (r=)');
      alert('Link inv√°lido: faltou o par√¢metro ?r=... (gere pelo Dashboard)');
    } else {
      const domain = "meet.jit.si";
      const options = {
        roomName: room,
        parentNode: document.querySelector('#jitsi'),
        userInfo: { displayName: "Atendente" },
        configOverwrite: {
          prejoinPageEnabled: false,
          startWithAudioMuted: true,
          startWithVideoMuted: true,
          disableDeepLinking: true,
          enableWelcomePage: false
        },
        interfaceConfigOverwrite: {
          TOOLBAR_BUTTONS: ['microphone','camera','desktop','fullscreen','hangup'],
          FILM_STRIP_MAX_HEIGHT: 120
        }
      };
      const api = new JitsiMeetExternalAPI(domain, options);

      function refocus(){
        try {
          // Focus the other participant if exists
          const parts = api.getParticipantsInfo ? api.getParticipantsInfo() : [];
          // Find "Associado"
          const assoc = parts.find(p => (p.displayName||'').toLowerCase().includes('associ'));
          if(assoc) api.executeCommand('pinParticipant', assoc.participantId);
        } catch(e) {}
      }
      document.getElementById('refocus').onclick = refocus;

      api.addEventListener('videoConferenceJoined', ()=>{
        setBadge('good','Conectado');
        setTimeout(refocus, 1500);
      });
      api.addEventListener('participantJoined', ()=>{
        setTimeout(refocus, 900);
      });
      api.addEventListener('readyToClose', ()=>{
        setBadge('warn','Encerrado');
      });
    }
  </script>
</body>
</html>
