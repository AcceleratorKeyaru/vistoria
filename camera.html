
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vistoria — Câmera do Associado</title>
  <link rel="stylesheet" href="assets.css" />
  <script src="https://meet.jit.si/external_api.js"></script>
</head>
<body>
  <div class="overlay">
    <div class="card">
      <div class="header">
        <div class="h-title">
          <h1>Vistoria — Câmera do Associado</h1>
          <div class="sub">Sala: <span id="roomLabel">—</span></div>
        </div>
        <div class="badge"><span class="dot warn"></span><span>Aguardando atendente…</span></div>
      </div>
      <div class="grid">
        <div class="row">
          <button class="btn" id="reload">Recarregar</button>
          <button class="btn" id="help">Ajuda</button>
        </div>
        <div class="small">Permita a câmera. Você se verá em tela cheia. Use a câmera traseira para filmar placa/chassi/motor.</div>
      </div>
    </div>
  </div>

  <div id="jitsi"></div>

  <footer class="credits">
    Plataforma desenvolvida por <b>Pedro Vinícius Moraes Alves</b>
  </footer>

  <script>
    
function getRoom(){
  const qs = new URLSearchParams(location.search);
  return (qs.get('r') || '').trim();
}
function setBadge(state, text){
  const dot = document.querySelector('.badge .dot');
  const label = document.querySelector('.badge span:last-child');
  if(!dot || !label) return;
  dot.classList.remove('good','warn','bad');
  dot.classList.add(state);
  label.textContent = text;
}

    const room = getRoom();
    document.getElementById('roomLabel').textContent = room || '—';
    document.getElementById('reload').onclick = ()=>location.reload();
    document.getElementById('help').onclick = ()=>alert(
      "1) Clique em Permitir (câmera).\n2) Se estiver preto, recarregue.\n3) Aguarde o atendente entrar."
    );
    if(!room){
      setBadge('bad','Sem sala (r=)');
      alert('Link inválido: faltou o parâmetro ?r=... (gere pelo Dashboard)');
    } else {
      const domain = "meet.jit.si";
      const options = {
        roomName: room,
        parentNode: document.querySelector('#jitsi'),
        userInfo: { displayName: "Associado" },
        configOverwrite: {
          prejoinPageEnabled: false,
          startWithAudioMuted: true,
          startWithVideoMuted: false,
          disableDeepLinking: true,
          enableWelcomePage: false,
          constraints: { video: { facingMode: 'environment' } }
        },
        interfaceConfigOverwrite: {
          // Keep it simple for associate; rely on hangup only
          TOOLBAR_BUTTONS: ['toggle-camera','hangup','camera'],
          FILM_STRIP_MAX_HEIGHT: 0
        }
      };
      const api = new JitsiMeetExternalAPI(domain, options);

      api.addEventListener('videoConferenceJoined', ()=>{
        // Make self camera the focus and avoid giant avatar
        try{ api.executeCommand('setTileView', true); }catch(e){}
        setTimeout(()=>{
          try{
            const me = api._myUserID || (api.getMyUserId && api.getMyUserId());
            if(me) api.executeCommand('pinParticipant', me);
          }catch(e){}
        }, 1200);
      });

      api.addEventListener('participantJoined', ()=>{
        setBadge('good','Conectado');
      });
      api.addEventListener('participantLeft', ()=>{
        setBadge('warn','Aguardando atendente…');
      });
    }
  </script>
</body>
</html>
