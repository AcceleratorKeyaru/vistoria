<!doctype html>
<html lang="pt-br"><head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vistoria — Câmera</title>
<link rel="stylesheet" href="./assets.css" />
</head>
<body style="background:#000">
<div class="overlay">
  <div class="card" style="padding:10px 12px; max-width: 620px">
    <div class="hdr" style="gap:10px">
      <div class="brand">
        <b>Vistoria — Câmera do Associado</b>
        <span id="roomTxt">Sala: —</span>
      </div>
      <div id="status" class="badge"><span class="dot"></span><span id="statusTxt">Abrindo…</span></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnRetry">Recarregar</button>
      <button class="btn" id="btnHelp">Ajuda</button>
    </div>
    <div id="help" class="small" style="display:none; margin-top:8px">
      1) Clique em <b>Permitir</b> para a câmera.<br/>
      2) Se abrir na frontal, toque em <b>Trocar câmera</b> dentro da tela.<br/>
      3) Ajuste o enquadramento olhando o próprio vídeo (self-view fica ligado).
    </div>
  </div>
</div>

<div id="meet" class="meet"></div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
const statusEl = document.getElementById("status");
const statusTxt = document.getElementById("statusTxt");
const roomTxt = document.getElementById("roomTxt");

function setStatus(mode, text){
  statusEl.classList.remove("ok","err");
  if(mode) statusEl.classList.add(mode);
  statusTxt.textContent = text;
}

document.getElementById("btnRetry").onclick = () => location.reload();
document.getElementById("btnHelp").onclick = () => {
  const h = document.getElementById("help");
  h.style.display = (h.style.display === "none") ? "block" : "none";
};

const url = new URL(location.href);
const room = (url.searchParams.get("r") || "vistoria-demo").trim();
roomTxt.textContent = "Sala: " + room;

async function pickRearCameraLabel(){
  try{
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio:false });
    const track = s.getVideoTracks()[0];
    const label = track && track.label ? track.label : null;
    s.getTracks().forEach(t=>t.stop());
    return label;
  }catch(e){
    return null;
  }
}

(async function start(){
  setStatus(null, "Conectando…");

  const rearLabel = await pickRearCameraLabel();

  const options = {
    roomName: room,
    parentNode: document.querySelector("#meet"),
    width: "100%",
    height: "100%",
    userInfo: { displayName: "Associado" },
    devices: rearLabel ? { videoInput: rearLabel } : undefined,
    configOverwrite: {
      prejoinPageEnabled: false,
      startWithAudioMuted: true,
      startWithVideoMuted: false,
      disableDeepLinking: true,
      disableSelfView: false
    },
    interfaceConfigOverwrite: {
      SHOW_JITSI_WATERMARK: false,
      SHOW_WATERMARK_FOR_GUESTS: false,
      MOBILE_APP_PROMO: false,
      DISABLE_JOIN_LEAVE_NOTIFICATIONS: true,
      TOOLBAR_BUTTONS: ['camera', 'hangup', 'tileview', 'toggle-camera', 'fullscreen']
    }
  };

  const api = new JitsiMeetExternalAPI("meet.jit.si", options);

  api.addEventListener("videoConferenceJoined", () => setStatus("ok", "Transmitindo"));
  api.addEventListener("readyToClose", () => setStatus(null, "Encerrado"));
  api.addEventListener("errorOccurred", () => setStatus("err", "Erro"));

  setStatus(null, "Abrindo câmera…");
})();
</script>
</body></html>
